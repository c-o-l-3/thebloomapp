generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id              String   @id @default(uuid())
  slug            String   @unique
  name            String
  locationId      String?  @unique @map("location_id")
  ghlLocationId   String?  @map("ghl_location_id")
  industry        String?
  website         String?
  status          String   @default("active")
  settings        Json     @default("{}")
  config          Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  pipelines       Pipeline[]
  journeys        Journey[]
  templates       Template[]
  workflows       Workflow[]
  clientUsers     ClientUser[]
  syncHistory     SyncHistory[]

  @@index([slug])
  @@index([status])
  @@index([ghlLocationId])
  @@map("clients")
}

model Pipeline {
  id          String   @id @default(uuid())
  clientId    String   @map("client_id")
  name        String
  pipelineId  String?  @map("pipeline_id")
  stages      Json     @default("[]")
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  journeys    Journey[]

  @@index([clientId])
  @@map("pipelines")
}

model Journey {
  id              String    @id @default(uuid())
  clientId        String    @map("client_id")
  pipelineId      String?   @map("pipeline_id")
  name            String
  slug            String?
  description     String?
  category        String?
  status          String    @default("draft")
  version         Int       @default(1)
  triggerConfig   Json?     @map("trigger_config")
  goal            String?
  metadata        Json      @default("{}")
  publishedAt     DateTime? @map("published_at")
  approvedAt      DateTime? @map("approved_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  pipeline        Pipeline? @relation(fields: [pipelineId], references: [id], onDelete: SetNull)
  touchpoints     Touchpoint[]
  versions        JourneyVersion[]
  approvals       Approval[]

  @@index([clientId])
  @@index([status])
  @@index([category])
  @@index([clientId, status])
  @@map("journeys")
}

model Touchpoint {
  id              String   @id @default(uuid())
  journeyId       String   @map("journey_id")
  name            String
  type            String
  orderIndex      Int      @map("order_index")
  content         Json
  config          Json     @default("{}")
  position        Json?
  ghlTemplateId   String?  @map("ghl_template_id")
  status          String   @default("draft")
  nextTouchpointId String? @map("next_touchpoint_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  journey         Journey  @relation(fields: [journeyId], references: [id], onDelete: Cascade)

  @@index([journeyId])
  @@index([type])
  @@index([journeyId, orderIndex])
  @@map("touchpoints")
}

model Template {
  id              String    @id @default(uuid())
  clientId        String?   @map("client_id")
  name            String
  type            String
  ghlTemplateId   String?   @unique @map("ghl_template_id")
  content         Json
  variables       Json      @default("[]")
  status          String    @default("draft")
  lastSynced      DateTime? @map("last_synced")
  syncStatus      String?   @map("sync_status")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  client          Client?   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([ghlTemplateId])
  @@index([type])
  @@map("templates")
}

model Workflow {
  id          String   @id @default(uuid())
  clientId    String   @map("client_id")
  name        String
  workflowId  String?  @map("workflow_id")
  status      String   @default("active")
  trigger     Json
  actions     Json     @default("[]")
  notes       Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("workflows")
}

model JourneyVersion {
  id          String   @id @default(uuid())
  journeyId   String   @map("journey_id")
  version     Int
  snapshot    Json
  createdBy   String?  @map("created_by")
  changeLog   String?  @map("change_log")
  createdAt   DateTime @default(now()) @map("created_at")

  journey     Journey  @relation(fields: [journeyId], references: [id], onDelete: Cascade)

  @@unique([journeyId, version])
  @@index([journeyId])
  @@index([journeyId, version])
  @@map("journey_versions")
}

model Approval {
  id            String    @id @default(uuid())
  journeyId     String    @map("journey_id")
  versionId     String?   @map("version_id")
  status        String
  comments      String?
  requestedBy   String?   @map("requested_by")
  reviewedBy    String?   @map("reviewed_by")
  reviewedAt    DateTime? @map("reviewed_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  journey       Journey   @relation(fields: [journeyId], references: [id], onDelete: Cascade)

  @@index([journeyId])
  @@index([status])
  @@map("approvals")
}

model User {
  id            String       @id @default(uuid())
  email         String       @unique
  name          String?
  role          String       @default("editor")
  permissions   Json         @default("{}")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  clientUsers   ClientUser[]

  @@map("users")
}

model ClientUser {
  id        String   @id @default(uuid())
  clientId  String   @map("client_id")
  userId    String   @map("user_id")
  role      String   @default("editor")
  createdAt DateTime @default(now()) @map("created_at")

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clientId, userId])
  @@map("client_users")
}

model SyncHistory {
  id            String   @id @default(uuid())
  clientId      String?  @map("client_id")
  operation     String
  status        String
  itemsSynced   Int?     @map("items_synced")
  errors        String?
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")

  client        Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("sync_history")
}

model MigrationLog {
  id          String   @id @default(uuid())
  operation   String
  status      String
  details     Json?
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("migration_logs")
}